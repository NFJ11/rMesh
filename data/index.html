<!DOCTYPE html>
<html lang="de">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" type="text/css" href="style.css"  />
		 <title>rMesh</title>
	</head>
	
	<body>

		<div style="display: flex; gap: 20px;">
			<div style="flex: 1; min-width: 0;">
				<h1>Monitor</h1>
				<div id="monitor" style="height: 200px; overflow-y: auto; border: 1px solid;"> </div>
				<button id="commandAnnounce">announce</button>
				<button id="commandTune">tune</button>
			</div>
			<div style="flex: 0 0 400px;">
				<h1>Peers</h1>
				<div id="peers" style="height: 200px; overflow-y: auto; border: 1px solid; "> </div>
			</div>
		</div>

		<h1>Status</h1>
		<div style="border: 1px solid; width: fit-content;">
			<table>
				<tr> <td>Uhrzeit:</td> <td><span id="statusTime"></span> <button id="statusSyncTime">sync</button> </td> </tr>
			</table>
		</div> <br>

		<h1>Einstellungen</h1>
		<div style="border: 1px solid; width: fit-content;">
			<table>
				<tr> <td>Callsign</td> <td><input style="width: 200px;" id="settingsMycall"></td> </tr>
				<tr> <td>NTP-Server</td> <td><input style="width: 200px;" id="settingsNTP"></td> </tr>
				<tr> <td> Accesspoint </td>  <td> <input type='checkbox' id='settingsApMode'> </td>	</tr> 
				<tr class="AP_MODE_ENABLED"> 
					<td> SSID </td> 
					<td> 
						Networks:
						<select id='settingsSSIDList' size='1'></select> 
						<button id="settingsScanWifi">scan</button> <br>
						SSID:
						<input id='settingsSSID' style='width: 200px;'>
					</td>
				</tr>
				<tr class="AP_MODE_ENABLED"> <td> Passwort </td> <td> <input type="password" id='settingsPassword' style='width: 200px;' > </td> 
				</tr>
				<tr class="AP_MODE_ENABLED"> <td> DHCP </td> <td> <input type='checkbox' id='settingsDHCP'> </td> </tr> 
				<tr class="DHCP_ENABLED AP_MODE_ENABLED"> <td> IP-Adresse </td> <td> <input style='width: 100px;' id='settingsWiFiIP'> </td> </tr>
				<tr class="DHCP_ENABLED AP_MODE_ENABLED"> <td> Subnetz </td> <td> <input style='width: 100px;' id='settingsWifiNetMask'> </td> </tr>
				<tr class="DHCP_ENABLED AP_MODE_ENABLED"> <td> Gateway </td> <td> <input style='width: 100px;' id='settingsWifiGateway'> </td> </tr>
				<tr class="DHCP_ENABLED AP_MODE_ENABLED"> <td> DNS </td> <td> <input style='width: 100px;' id='settingsWifiDNS'> </td> </tr>

				<tr> <td>Frequency</td> <td><input style="width: 200px;" id="settingsLoraFrequency"></td> </tr>
				<tr> <td>Output Power</td> <td><input style="width: 200px;" id="settingsLoraOutputPower"></td> </tr>
				<tr> <td>Bandwidth</td> <td>
					<select id='settingsLoraBandwidth'>
						<option value="31.25">31,25 kHz</option>	
						<option value="62.5">62,5 kHz</option>	
						<option value="125">125 kHz</option>	
						<option value="250">250 kHz</option>	
						<option value="500">500 kHz</option>	
					</select> 
				</td> </tr>
				<tr> <td>Coding Rate</td> <td>
					<select id='settingsLoraCodingRate'>
						<option value="5">5 - Standard</option>	
						<option value="6">6 - Erhöhter Schutz gegen Störungen</option>	
						<option value="7">7 - Hoher Schutz, deutlich längere Sendezeit</option>	
						<option value="8">8 - Maximaler Schutz</option>	
					</select> 
				</td> </tr>				
				<tr> <td>Spreading Factor</td> <td>
					<select id='settingsLoraSpreadingFactor'>
						<option value="6">6 - Gering (Sichtverbindung)</option>	
						<option value="7">7 - Gut (Standard)</option>	
						<option value="8">8 - Besser</option>	
						<option value="9">9 - Sehr gut</option>	
						<option value="10">10 - Exzellent</option>	
						<option value="11">11 - Maximum</option>	
						<option value="12">12 - Maximum (Deep Indoor)</option>	
					</select> 
				</td> </tr>
				<tr> <td>Sync Word</td> <td><input style="width: 200px;" id="settingsLoraSyncWord"></td> </tr>		
				<tr> <td>PreambleLength</td> <td><input style="width: 200px;" id="settingsLoraPreambleLength"></td> </tr>		
				
				
			</table>
			<button id="settingsSave">Save</button>
			<button id="settingsReboot">Reboot</button> <br>
		</div> <br>

		<script>
			var websocket;
			var timeout = 0;

			document.addEventListener('DOMContentLoaded', function() {
				//Verbinden
				initWebSocket();
			});

			document.getElementById("settingsSave").addEventListener("click", function() {
				var settings = {};
				settings["mycall"] = document.getElementById("settingsMycall").value;
				settings["ntp"] = document.getElementById("settingsNTP").value;
				settings["dhcpActive"] = document.getElementById("settingsDHCP").checked;
				settings["wifiSSID"] = document.getElementById("settingsSSID").value;
				settings["wifiPassword"] = document.getElementById("settingsPassword").value;
				settings["apMode"] = document.getElementById("settingsApMode").checked;
				settings["wifiIP"] = document.getElementById("settingsWiFiIP").value.split('.').map(Number);
				settings["wifiNetMask"] = document.getElementById("settingsWifiNetMask").value.split('.').map(Number);
				settings["wifiGateway"] = document.getElementById("settingsWifiGateway").value.split('.').map(Number);
				settings["wifiDNS"] = document.getElementById("settingsWifiDNS").value.split('.').map(Number);
				settings["loraFrequency"] = parseFloat(document.getElementById("settingsLoraFrequency").value);
				settings["loraOutputPower"] = parseInt(document.getElementById("settingsLoraOutputPower").value);
				settings["loraBandwidth"] = parseFloat(document.getElementById("settingsLoraBandwidth").value);
				settings["loraSyncWord"] = parseInt(document.getElementById("settingsLoraSyncWord").value, 16);
				settings["loraCodingRate"] = parseInt(document.getElementById("settingsLoraCodingRate").value);
				settings["loraSpreadingFactor"] = parseInt(document.getElementById("settingsLoraSpreadingFactor").value);
				settings["loraPreambleLength"] = parseInt(document.getElementById("settingsLoraPreambleLength").value);

				sendWS(JSON.stringify({settings: settings}));
			});

			document.getElementById("settingsApMode").addEventListener("change", function() { settingsVisibility(); });

			document.getElementById("settingsDHCP").addEventListener("change", function() { settingsVisibility(); });

			
			document.getElementById("commandAnnounce").addEventListener("click", function() {
				sendWS(JSON.stringify({announce: true }));
			});

			document.getElementById("commandTune").addEventListener("click", function() {
				sendWS(JSON.stringify({tune: true }));
			});
			
			document.getElementById("settingsReboot").addEventListener("click", function() {
				sendWS(JSON.stringify({reboot: true }));
			});

			document.getElementById("statusSyncTime").addEventListener("click", function() {
				sendWS(JSON.stringify({time: Math.floor(Date.now() / 1000) }));
			});

			document.getElementById("settingsScanWifi").addEventListener("click", function() {
				sendWS(JSON.stringify({scanWifi: true }));
			});

			document.getElementById("settingsSSIDList").addEventListener("click", function() {
				document.getElementById("settingsSSID").value = document.getElementById("settingsSSIDList").value;
			});

			function onMessage(event) {
				var d = JSON.parse(event.data);
				if (d.time === undefined) {console.log("RX: " + event.data);}

				//RAW-RX
				if (d.monitor) {
					var msg = "<br>";
					//Bytes
					if (d.monitor.tx == true) {msg += "TX: ";} else {msg += "RX: ";}
					msg += d.monitor.data.map(b => b.toString(16).padStart(2, '0')).join(' ').toUpperCase();
					msg += " (RSSI:" + d.monitor.rssi + "dBm SNR:" + d.monitor.snr + "db)";
					document.getElementById("monitor").innerHTML = document.getElementById("monitor").innerHTML + "<br>" + msg;

					//Text
					msg = "";
					if (d.monitor.tx == true) {msg += "TX: ";} else {msg += "RX: ";}
					for (let i = 0; i < d.monitor.data.length; i++) {
						msg += String.fromCharCode(d.monitor.data[i]);
					}
					document.getElementById("monitor").innerHTML = document.getElementById("monitor").innerHTML + "<br>" + msg;

					//Decodiert
					msg = "";
					const rxTime = new Date(d.monitor.time * 1000);
					msg += rxTime.toLocaleTimeString('de-DE') + " ";
					if (d.monitor.tx == true) {msg += "TX: ";} else {msg += "RX: ";}
					//Rufzeichen ausschneiden
					var frame = d.monitor.data;
					var srcCall;
					var viaCall = [];
					var dstCall;
					const decoder = new TextDecoder();
					//Frame druchlaufen
					for (i=1; i < frame.length; i++) {
						//Header prüfen
						switch (frame[i] & 0xF0) {
							case 0x00:
								var len = frame[i] & 0x0F;
								var payload = frame.slice(i + 1, i + len + 1);
								srcCall = decoder.decode(new Uint8Array(payload));
								i += len;
								break;
							case 0x10:
								var len = frame[i] & 0x0F;
								var payload = frame.slice(i + 1, i + len + 1);
								dstCall = decoder.decode(new Uint8Array(payload));
								i += len;
								break;
						}
					}
					//Frame-Type
					switch (frame[0]) {
  						case 0x00: msg += "Announce from " + srcCall; break;
  						case 0x01: msg += "Announce Reply from " + srcCall + " to " + dstCall; break;
  						case 0x02: msg += "Tuning Frame from " + srcCall; break;
					}
					document.getElementById("monitor").innerHTML = document.getElementById("monitor").innerHTML + "<br>" + msg;
					document.getElementById('monitor').scrollTop = document.getElementById("monitor").scrollHeight;
					
				}

				//Peers
				if (d.peerlist) {
					var peers = "";
					peers += "<table>";
					peers += "<tr> <td>Call</td> <td>Last RX</td> <td>RSSI</td> <td>SNR</td> <td>Frq. Error</td> <td>Available</td> </tr>";
					if (d.peerlist.count > 0) {
						d.peerlist.peers.forEach(function(p, index) {
							const lastRX = new Date(p.lastRX * 1000);
							peers += "<tr>";
							peers += "<td>" + p.call + "</td>";
							peers += "<td>" + lastRX.toLocaleTimeString('de-DE') + "</td>";
							peers += "<td>" + p.rssi + "</td>";
							peers += "<td>" + p.snr + "</td>";
							peers += "<td>" + parseInt(p.frqError) + "</td>";
							peers += "<td>" + p.available + "</td>";
							peers += "</tr>";
					 	});
					}
					peers += "</table>";
					document.getElementById("peers").innerHTML = peers;
				}

				//Einstellungen
				if (d.settings) {
					document.getElementById("settingsMycall").value = d.settings.mycall;
					document.getElementById("settingsNTP").value = d.settings.ntp;
					document.getElementById("settingsSSID").value = d.settings.wifiSSID;
					document.getElementById("settingsPassword").value = d.settings.wifiPassword;
					document.getElementById("settingsWiFiIP").value = d.settings.wifiIP[0] + "." + d.settings.wifiIP[1] + "." + d.settings.wifiIP[2] + "." + d.settings.wifiIP[3];
					document.getElementById("settingsWifiNetMask").value = d.settings.wifiNetMask[0] + "." + d.settings.wifiNetMask[1] + "." + d.settings.wifiNetMask[2] + "." + d.settings.wifiNetMask[3];
					document.getElementById("settingsWifiGateway").value = d.settings.wifiGateway[0] + "." + d.settings.wifiGateway[1] + "." + d.settings.wifiGateway[2] + "." + d.settings.wifiGateway[3];
					document.getElementById("settingsWifiDNS").value = d.settings.wifiDNS[0] + "." + d.settings.wifiDNS[1] + "." + d.settings.wifiDNS[2] + "." + d.settings.wifiDNS[3];
					document.getElementById("settingsDHCP").checked = d.settings.dhcpActive; 
					document.getElementById("settingsApMode").checked = d.settings.apMode; 
					document.getElementById("settingsLoraFrequency").value = d.settings.loraFrequency; 
					document.getElementById("settingsLoraOutputPower").value = d.settings.loraOutputPower; 
					document.getElementById("settingsLoraBandwidth").value = d.settings.loraBandwidth; 
					document.getElementById("settingsLoraSyncWord").value = d.settings.loraSyncWord.toString(16).padStart(2, '0').toUpperCase(); 
					document.getElementById("settingsLoraCodingRate").value = d.settings.loraCodingRate; 
					document.getElementById("settingsLoraSpreadingFactor").value = d.settings.loraSpreadingFactor; 
					document.getElementById("settingsLoraPreambleLength").value = d.settings.loraPreambleLength; 
					
					settingsVisibility();
				}

				//Uhrzeit
				if (d.time) {
					const date = new Date(d.time * 1000);
					document.getElementById("statusTime").innerHTML = date.toLocaleString("de-DE");
				}

				//WiFi Scan
				if (d.wifiScan) {
					const select = document.getElementById('settingsSSIDList');
					select.length = 0;
					d.wifiScan.forEach(n => {
						let opt = document.createElement('option');
						opt.value = n.ssid;
						opt.text = n.ssid + " (" + n.encryption + ", " + n.rssi +  "dBm)";
						select.add(opt);
					});
				}


			}		
		
			function keepAlive() { 
				if (websocket.readyState == websocket.OPEN) {  
					websocket.send(JSON.stringify({ping: new Date() }));
				}  
				timeout = setTimeout(keepAlive, 1000);  
			}

			function initWebSocket() {
				var gateway; 
				if (window.location.hostname.length > 0) {
					gateway = `ws://${window.location.hostname}/socket`;
				} else {
					gateway = "ws://192.168.33.66/socket";
				}
				websocket = new WebSocket(gateway);
				websocket.onopen = onOpen;
				websocket.onclose = onClose;
				websocket.onmessage = onMessage;
			}

			function onOpen(event) {
				//sendWS(JSON.stringify({scanWifi: true }));
				keepAlive();
			}

			function onClose(event) {
				clearTimeout(timeout);
				setTimeout(initWebSocket, 500);
			}

			function sendWS(text) {
				websocket.send(text);
				console.log("TX: " + text);
			}

			function settingsVisibility() {
				if (document.getElementById("settingsApMode").checked) {
					for (e of document.getElementsByClassName('DHCP_ENABLED')) {
						e.style.display = "none";
					}
					for (e of document.getElementsByClassName('AP_MODE_ENABLED')) {
						e.style.display = "none";
					}				
				} else {
					for (e of document.getElementsByClassName('AP_MODE_ENABLED')) {
						e.style.display = "";
					}				
					if (document.getElementById("settingsDHCP").checked) {
						for (e of document.getElementsByClassName('DHCP_ENABLED')) {
							e.style.display = "none";
						}
					} else {
						for (e of document.getElementsByClassName('DHCP_ENABLED')) {
							e.style.display = "";
						}
					}
				}
			}


		</script>


	</body>

	


</html>